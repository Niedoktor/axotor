<!doctype html>
<html lang="pl">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Axotor — Strona główna</title>
  <meta name="description" content="Prosty, responsywny szablon strony głównej dla projektu Axotor." />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core/index.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/map-plugin@5/index.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/markers-plugin@5/index.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/virtual-tour-plugin@5/index.css" />
  <style>
    * {
      box-sizing: border-box
    }

    /* Wyśrodkowanie w poziomie i pionie */
    body {
      margin: 0;
      min-height: 100vh;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #EDEFF3;
    }

    .wrap {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh; /* zajmuje pełną wysokość widoku */
      padding: 0;
    }

    #viewer {
      max-width: 100%;
      max-height: 100vh;
      width: 100vh;
      height: 100vh;
      display: block;
      background: #EDEFF3;
      outline: none;
      object-fit: contain;
    }
  </style>
</head>

<body>
  <div class="wrap card" id="container">
    <div id="viewer"></div>
  </div>
</body>

<script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three/build/three.module.js",
            "@photo-sphere-viewer/core": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core/index.module.js",
            "@photo-sphere-viewer/map-plugin": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/map-plugin@5/index.module.js",
            "@photo-sphere-viewer/markers-plugin": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/markers-plugin@5/index.module.js",
            "@photo-sphere-viewer/virtual-tour-plugin": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/virtual-tour-plugin@5/index.module.js"
        }
    }
</script>

<script type="module">
    import { Viewer } from '@photo-sphere-viewer/core';
    import { MapPlugin } from '@photo-sphere-viewer/map-plugin';
    import { MarkersPlugin } from '@photo-sphere-viewer/markers-plugin';
    import { VirtualTourPlugin } from '@photo-sphere-viewer/virtual-tour-plugin';

    const spots = [];
    const spotPoints = [];

    const img = new Image();
    img.src = "files/spacery_pliki/rzut_z_alpha0000.png";
    img.addEventListener("load", () => {
      const canvas = document.createElement("canvas");
      canvas.width = 100; //img.width;
      canvas.height = 100; //img.height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, canvas.width, canvas.height);
      img.style.display = "none";
      const pixel = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = pixel.data;

      for(let y = 0; y < canvas.height; y++) {
        for(let x = 0; x < canvas.width; x++) {
          const index = (y * canvas.width + x) * 4;
          if(data[index + 3] !== 255 && !getSpotFromPoint(x, y)) {
            let spot = [];
            const tol = 3;
            for(let y2 = y; y2 <= y + tol; y2++) {
              for(let x2 = x - tol; x2 <= x + tol; x2++) {
                if(x2 < 0 || x2 >= canvas.width || y2 < 0 || y2 >= canvas.height) continue;
                const index2 = (y2 * canvas.width + x2) * 4;
                if(data[index2 + 3] !== 255) {
                  spot.push({id: '' + spotPoints.length, x: x2, y: y2});
                }
              }
            }
            spotPoints.push(spot);
          }
        }
      }

      spotPoints.forEach(points => {
        const sum = points.reduce((acc, point) => {
          return {x: acc.x + point.x, y: acc.y + point.y};
        }, {x: 0, y: 0});
        const spot = {id: points[0].id, x: sum.x / points.length, y: sum.y / points.length};
        spots.push(spot);
      });

      createViewer(0);
    });

    function getSpotFromPoint(x, y){
      for(let s = 0; s < spotPoints.length; s++) {
        const spot = spotPoints[s];
        for(let point of spot) {
          if(point.x === x && point.y === y) {
            return spotPoints[s];
          }
        }
      }

      return undefined;
    }

    function createViewer(spotIndex) {
      const nodeRotation = [ -Math.PI / 2, -Math.PI / 4, Math.PI / 2, -Math.PI / 2, -Math.PI * 0.6, Math.PI / 4];

      const viewer = new Viewer({
        container: document.querySelector('#viewer'),
        defaultZoomLvl: 0,

        plugins: [
          // MapPlugin.withConfig({
          //     imageUrl: 'files/spacery_pliki/spacery_do_rzutu_000/ucz_rzut_0000.jpg',
          //     center: { x: 4000 * spot.x / 100, y: 4000 * spot.y / 100 },
          //     defaultZoom: 7,
          //     minZoom: 5,
          //     shape: 'square',
          //     static: true
          // }),
          //MarkersPlugin,
          MapPlugin.withConfig({
              defaultZoom: 7,
              minZoom: 5,
              shape: 'square',
              static: true,
              spotStyle: {
                color: 'white',
                borderSize: 2,
                borderColor: '#1E78E6',
              }
          }),
          VirtualTourPlugin.withConfig({
            positionMode: 'manual',
            renderMode: '2d',
            preload: true,
            transitionOptions: (node) => {
              return {
                showLoader: false,
                speed: '20rpm',
                effect: 'fade',
                rotation: true,
                rotateTo: { yaw: nodeRotation[parseInt(node.id)], pitch: 0 }
              }
            },
            nodes: spots.map((spot, i) => { return {
              id: spot.id,
              panorama: 'files/spacery_pliki/spacery_do_rzutu_000/ucz_SPACERY_000' + i + '.jpg',
              name: 'Spot ' + i,
              map: { x: 4000 * spot.x / 100, y: 4000 * spot.y / 100 },
              links: spots.filter((s, j) => i !== j).map((spot2, j) => { return {
                nodeId: spot2.id,
                position: { yaw: Math.atan2(spot2.y - spot.y, spot2.x - spot.x) + Math.PI / 2, pitch: 0 },
              }}),
              // markers: spots.filter((s, j) => i !== j).map((spot2, j) => { return {
              //   id: spot2.id,
              //   position: { yaw: Math.atan2(spot2.y - spot.y, spot2.x - spot.x) + Math.PI / 2, pitch: 0 },
              //   circle: 20,
              //   // data: {
              //   //   map: {
              //   //     distance: 220,
              //   //     circle: 10,
              //   //   },
              //   // },
              //   svgStyle: {
              //     fill: 'rgba(255, 255, 255, 0.5)',
              //     stroke: '#8888FF',
              //     strokeWidth: '2px'
              //   }
              // }})
            }}),
            map: {
              imageUrl: 'files/spacery_pliki/spacery_do_rzutu_000/ucz_rzut_0000.jpg',
              defaultZoom: 7,
              minZoom: 5,
              shape: 'square',
              static: true              
            },
            startNodeId: '' + spotIndex,
          })
          // MarkersPlugin.withConfig({
          //   markers: spots.filter((spot, i) => { return i !== spotIndex; }).map((spot, i) => { return {
          //     id: 'spot' + i,
          //     position: { yaw: 0.11, pitch: 0 },
          //     circle: 10,
          //     data: {
          //       map: {
          //         distance: 220,
          //         circle: 10,
          //       },
          //     },
          //     svgStyle: {
          //       fill: 'rgba(255, 255, 255, 0.5)',
          //       stroke: '#0000FF',
          //       strokeWidth: '2px'
          //     }
          //   }})
          // })
        ],
      });

      // const markersPlugin = viewer.getPlugin(MarkersPlugin);
      const virtualTourPlugin = viewer.getPlugin(VirtualTourPlugin);
      // markersPlugin.addEventListener('select-marker', ({ marker }) => {
      //   virtualTourPlugin.setCurrentNode(marker.id);
      //   console.log('Marker selected:', marker.id);
      // });
      // virtualTourPlugin.addEventListener('node-changed', ({ node, data }) => {
      //   viewer.rotate({ yaw: nodeRotation[parseInt(node.id)], pitch: 0 });
      // });
    }
</script>

</html>